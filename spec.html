<!doctype html>
<html lang="en">
<head>
<title>Thormor Vault Specification</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<link rel="stylesheet" href="css/style.css"/>
</head>
<body>
<h1>Thormor Vault Specification</h1>

<p>This document describes the format and organization of thormor
vaults. Please read the
<a href="index.html" title="Introduction to Thormor Vaults">introduction to vaults</a>
for additional background.</p>

<h2>General guidelines</h2>

<ul>
<li><p>Thormor Vaults use <a href="http://www.ietf.org/rfc/rfc4880.txt">OpenPGP</a>
for all encryption and signing.</p></li>
<li><p>Data is signed with the sender's key, and clients <em>must</em> validate
the signature.</p></li>
<li><p>When data is also encrypted, the PGP anonymous mode is used (keyid
in the header set to 0.) This prevents casually determining who can
decrypt a given file.</p></li>
<li><p>Both ASCII-armored and binary formatted PGP files may be used.</p></li>
</ul>

<h2>File organization and details</h2>

<p>Unless otherwise noted, files are in JSON format. All content must be
publicly accessible through stable URLs.</p>

<h3>The root file</h3>

<p>A thormor vault is identified by a unique URL, say
  <tt>https://dl.dropbox.com/u/1234/thormor/root.asc</tt></p>

<p>This URL must return a signed JSON file. For example, an ascii-armored
file may look like:</p>

<pre><code>-----BEGIN PGP MESSAGE-----
Version: GnuPG v1.4.11 (Darwin)

owGbwMvMwMRsYirJuyM+7jPjmi1JnEX5+SV6WcX5ef67zxRWcykAgVJZalFxZn6e
kpWCoQ5EpKA0KSczOT47tRIoqJRRUlJQbKWvn5Kjl1KUX5CUX6GXnJ+rX6pvaGRs
ol+SkV+Um1+kDza5ILtICWpGfmkJUGV8TmZxCfGGIGnSSyxOVuKq5epklGFhYGZi
YGNlArmZgYtTAOYjXwP2/4HiGqwSE5IfFDSbz61N01MuqFOqnnlu6w7N2O21a32X
Xmf4VL4jyj2w4fCLC9Uzb63b6r7haJygsBzzoiSnHxsbHp8qqgmssD5xqv52AlML
90bjuEMfo/ZlHPMTt72x7oXRhUj2tym6s9cKfIqan+HcUD03ziknwu3yByuv5hen
ajJXX7rvf/oos2HojZTiv2/vOWgYubz5PjmjvzzxwYK6/0kLKw6EBK3hfM+3dM7n
gNovs/1Tfu/4uvd5ixXv55ALy2N+v9/eabYykmXf10U7X+pGVKbpn1izYd7vDtUV
Lkfucy8J9b9rWhXZubBSbk33Uhe1MyVuK+/c3CdzoTjiiuhWmbbXCzyCGEv/agEA
=h3eh
-----END PGP MESSAGE-----
</code></pre>

<p>The contents must be a JSON file, in the above example it is:</p>

<pre><code>{
    "version": 1,
    "public_key": "https://dl.dropbox.com/u/1234/thormor/root.pkr",
    "outbox_list": "https://dl.dropbox.com/u/1234/thormor/outbox_list.asc"
}
</code></pre>

<h4>Required fields</h4>

<ul>
<li>version: 1</li>
<li>public_key: URL to the public key for the user who owns the vault.</li>
<li>outbox_list: URL to a signed JSON file containing a list of outbox urls.</li>
</ul>

<h3>The public_key file</h3>

<p>This is a standard PGP public key.</p>

<p><strong>Note:</strong> Keys should be independently verified using the standard
mechanisms that PGP provides, ie: directly verifying key fingerprints.
A thormor vault itself provides no guarantees that the public key
actually belongs to any given individual.</p>

<h3>The outbox_list file</h3>

<p>The outbox_list URL must return a signed JSON file. The contents must
be a JSON file with a list of outbox entries, for example:</p>

<pre><code>{
  "version": 1,
  "outbox_list": [
     { "outbox": "-----BEGIN PGP MESSAGE-----\\n...END PGP MESSAGE-----" },
     { "outbox": "-----BEGIN PGP MESSAGE-----\\n...END PGP MESSAGE-----" },
     ...
  ]
}
</code></pre>

<p>Outbox URLs are not directly represented in the outbox list. Instead,
each outbox URL is encrypted with that recipient's public key, and the
ascii-armored version is used as the outbox value.</p>

<p>This is mainly to prevent casually obtaining a list of recipient ids
who can access the vault, but serves no other cryptographic purpose.</p>

<p>Recipients download the outbox list from a sender's thormor vault and
try to decrypt each entry with the recipient's key. If an entry is
successfully decrypted, it uses the decrypted content as a URL
pointing to the outbox file for that recipient.</p>

<p><strong>Note:</strong> there may be multiple entries for the same recipient in the
outbox file. This is not an error -- the recipient is expected to look
for messages in all outboxes it can find. The reason for this is to
simplify storing messages from multiple devices to a single
vault. Each device may choose to add an outbox file unique to messages
originating from that device, which makes it a little easier to avoid
clobbering messages from other devices.</p>

<h4>Required fields</h4>

<ul>
<li>version: 1</li>
<li>outbox_list: An array of JSON objects, one for each recipient who
can fetch content from this thormor vault.<br/>
Each JSON object has one field.
<ul>
<li>outbox:
 An ascii-armored string with encrypted content. The content
 is simply the URL to the outbox file for the recipient. The
 URL string is first encrypted with the recipient's public
 key, then ascii-armored to create the entry. It is not
 necessary to sign it (as the entire file is already signed.)</li>
</ul></li>
</ul>

<p><strong>Note:</strong> implementations should maintain the same outbox URL for a
recipient as new messages are added, and update the contents of the
outbox file rather than changing the location of the outbox file.</p>

<h3>The outbox file</h3>

<p>The outbox URL for a recipient points to an signed JSON file encrypted
with the recipients public key. The format is intended to be extended
by applications, and any unknown fields must be skipped. An example
file (before encryption) might be:</p>

<pre><code>{
  "version": 1,
  "name": "KB Sriram",
  "profile_image": "https://box.net/santoehu/content/2983.pgp",
  "entries": [
     {
        "id": "fdfbdd42877c6e2bab0a73531caeed173172ceec",
        "type": "thormor/file",
        "mime-type": "application/pdf",
        "src": "https://box.net/santoehu/content/82837.pgp",
        "text": "Mortgage details",
        "name": "home_mortgage.pdf",
        "size": 988284,
        "created": 13848992828,
        "tags": ["finance"]
     },
     {
        "id": "e2e3b086c3f3c674e161bb02841a44a8b346dd7c",
        "type": "thormor/file",
        "mime-type": "image/jpeg",
        "src": "https://box.net/santoehu/content/a9oeu7.pgp",
        "text": "Kids at the ballpark!",
        "name": "IMG_0402.JPG",
        "size":  947520,
        "created": 13848992828,
        "tags": ["kids", "family"]
     }
   ]
}
</code></pre>

<h4>Required fields</h4>

<ul>
<li>version: 1</li>
<li>entries:
an array of JSON objects, one for each message. Each message
object must have these fields:
<ul>
<li>type: the type of message. Some pre-defined types are
     available, and implementations may define additional
     ones. Pre-defined types are described later.</li>
<li>id: A unique string for this entry. Other entries may refer
   to this id.</li>
<li>created: milliseconds from the unix epoch, indicating when the
   message was created. Entries <em>should</em> be listed in reverse
   chronological order.</li>
<li>tags: (optional) An array of strings, each string is a
   free-form tag for that message.</li>
</ul></li>
</ul>

<h4>Optional fields</h4>

<ul>
<li>next: URL to another outbox file, with the next set of messages for
    the recipient.</li>
<li>profile_image: URL to an encrypted image for the vault owner.</li>
<li>name: The name of the vault owner.</li>
</ul>

<h2>Pre-defined types for messages</h2>

<p><strong>Note:</strong> All types must have the standard required fields (type, id and
created.) The rest of this only describes additional requirements on
the fields.</p>

<h3>type: thormor/text</h3>

<p>This message type lets you share a simple text message.</p>

<h4>Required fields</h4>

<ul>
<li>text: The contents of the text message.</li>
</ul>

<h3>type: thormor/file</h3>

<p>This is a generic way to share digital content.</p>

<h4>Required fields</h4>

<ul>
<li>src: URL to encrypted file</li>
</ul>

<h4>Optional fields</h4>

<ul>
<li>mime-type: mime type for the associated content.</li>
<li>name: Suggested file name.</li>
<li>text: A message to go along with this file.</li>
<li>size: size of file in bytes.</li>
<li>thumbnail: URL to an encrypted "small" image to represent the contents.</li>
</ul>

<h3>type: thormor/comment</h3>

<p>Add a comment to a previous message (can also be a comment, leading to
threaded comments.)</p>

<h4>Required fields</h4>

<ul>
<li>parent: id for the message being commented.</li>
<li>text: Contents of the comment.</li>
</ul>

<h3>type: thormor/like</h3>

<p>'like' a particular message.</p>

<h4>Required fields</h4>

<ul>
<li>parent: id for the message being liked.</li>
</ul>

<h2>Detached Messages</h2>

<p>A detached message is just an encrypted (and signed) JSON file for an
individual message, and exists independently rather than being an
element in the <code>entries</code> array in an outbox.</p>

<p>Such messages do not need any of the outbox data structures, and may
be easier to create and maintain. URLs to such files are embedded
within pre-existing communication channels between the sharers. (eg:
in a status update to a set of people on twitter or facebook.) Client
applications for the recipients can directly access and decrypt such a
message, thereby providing a private, secure layer within that system.</p>
</body>
</html>
